Spring Music
============

This is a sample application for using database services on [Tanzu Platform](https://tanzu.vmware.com/platform) with the [Spring Framework](https://spring.io) and [Spring Boot](https://projects.spring.io/spring-boot/).

This application has been built to store the same domain objects in one of a variety of different persistence technologies - relational database, document store, and key-value store. This sample, when generated by Tanzu Application Accelerator, allows you to choose the one most applicable to the type of data you need to store..

The application use Spring Java configuration and [bean profiles](http://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-profiles.html) to configure the application and the connection objects needed to use the persistence stores.

## Building

This project requires Java version 17 or later to compile.

To build a runnable Spring Boot jar file, run the following command:

```shell
./gradlew clean assemble
```

## Running the application locally

### Starting the database server

<!--- #IF(#persistenceType == 'jpa') -->
One Spring bean profile should be activated to choose the database provider that the application should use.
The profile is selected by setting the system property `spring.profiles.active` when starting the app.

The supported databases are:

- H2
    - this is an in memory database so it does not need a profile and it gets started during the application startup
- mysql
    - add this profile to the java command below `-Dspring.profiles.active=mysql`
- postgresql
    - add this profile to the java command below `-Dspring.profiles.active=postgres`

The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

Or, if you want to specify a profile, then use the following command:

```shell
java -Dspring.profiles.active=<database-profile> -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'redis') -->
Start the redis server using:

```shell
docker run --rm --name redis -p 6379:6379 -d redis
```
The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'mongodb') -->
Start the MongoDB server using:

```shell
docker run --rm --name mongodb -p 27017:27017 -d mongodb/mongodb-community-server:latest
```

The application can be started locally using the following command:

```shell
java -jar build/libs/spring-music-1.0.0.jar
```

<!--- #ENDIF -->
Access the application by opening your browser using the URL [http://localhost:8080](http://localhost:8080)

<!--- #IF(#deploymentType == 'kubernetes') -->
## Deploying the application to Kubernetes

<!--- #IF(#persistenceType == 'redis') -->
You can deploy a Redis instance using a Bitnami helm chart.

```shell
helm install music oci://registry-1.docker.io/bitnamicharts/redis
```
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'mongodb') -->
You can deploy a MongoDB instance using a Bitnami helm chart.

```shell
helm install music oci://registry-1.docker.io/bitnamicharts/mongodb
```
<!--- #ENDIF -->
<!--- #IF(#persistenceType == 'jpa') -->
You can deploy the application as is if you want to use the embedded `H2` database.

### Using a MySQL database

For MySQL you can deploy an instance using a Bitnami helm chart.

```shell
helm install music oci://registry-1.docker.io/bitnamicharts/mysql
```

Then edit the `kubernetes/deployment.yaml` file and uncomment the `environment for MySQL` section.

### Using a PostgreSQL database

For PostgreSQL you can deploy an instance using a Bitnami helm chart.

```shell
helm install music oci://registry-1.docker.io/bitnamicharts/postgresql
```

Then edit the `kubernetes/deployment.yaml` file and uncomment the `environment for PostgreSQL` section.
<!--- #ENDIF -->

Build an OCI image using the following command - replace `${REGISTRY}` placeholder with the registry you are configured to use.

```shell
./gradlew bootBuildImage --imageName=${REGISTRY}/spring-music
```

Push the OCI image to the registry:

```shell
docker push ${REGISTRY}/spring-music
```

Update the `./kubernetes/deployment.yaml` file replacing `<REGISTRY>` placeholder with the registry you used above.

> NOTE: If you need to use an image pull secret uncomment that section in the `kubernetes/deployment.yaml` file and create an image pull secret using:

```
kubectl create secret docker-registry registry-credentials \
 --docker-server=${REGISTRY_SERVER} \
 --docker-username=${REGISTRY_USERNAME} \
 --docker-password=${REGISTRY_PASSWORD} \
 --docker-email=${YOUR_EMAIL}
```

Now, you can apply the deployment and the service using:

```shell
kubectl apply -f ./kubernetes/
```

Start a port-forward using:

```shell
kubectl port-forward service/spring-music 8080:80
```

Then, access the application by opening your browser using the URL [http://localhost:8080](http://localhost:8080)
<!--- #ENDIF -->
